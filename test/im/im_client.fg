import '../ui'
import '../mesh'

port = 9999

####### net

client = [

    'contacts' : (sys.load('contacts') or []),
    'roster' : [],
    'unread' : [],
    'mesh' : Mesh,

    'handle_message' : function(self, socket, mc1)
        e = mc1.event
        if (e == 'greet') then
            return ['event' : self.entrance] + self.creds
        else if e == 'signin' then
            self.handle_signin(socket, mc1)
        else if e == 'chat' then
            self.handle_chat(mc1.chat, mc1.from)
        else if e == 'contacts' then
            self.handle_contacts(mc1.contacts)
        else if e == 'online' then
            self.handle_online(mc1.from, mc1.online)
        else
            self.sync.handle_message(socket, mc1)
        end
    end,

    'connected' : function(self, socket)
        self.mesh.print('connected ' + socket)
        self.server = socket
    end,

    'handle_contacts' : function(self, contacts)
        self.mesh.print('handle_contacts ' + contacts)
        self.contacts = contacts
        onlines = self.available_contacts()
        self.update_roster(onlines)
    end,

    'handle_online' : function(self, from, state)
        self.contacts[from].online = state
        self.mesh.print('handle_online ' + self.contacts)
        onlines = self.available_contacts()
        self.update_roster(onlines)
    end,

    'available_contacts' : function(self)
        sys.print('ac : ' + self.contacts)
        self.roster = [k for k,v in self.contacts where v.online]
        sys.print('roster : ' + self.roster)
        return self.roster
    end,

    'update_roster' : function(self, contacts)
        sys.ui_set(self.ui.roster)
    end,

    'handle_signin' : function(self, socket, mc3)
        if mc3.result then
            self.contacts = mc3.contacts
            sys.save(self.creds, 'creds')
            self.main()
        else
            self.creds = nil
            sys.ui_set(self.ui.error, mc3.error)
        end
    end
]


####### ui

client.select = function(self)

    self.transcript = ''
    row = sys.args()[1]
    peer = self.roster[row]
    send = function(self)(peer)
        text = sys.form_get(self.ui).sezme
        msgtext = ['from':self.mesh.id, 'to':peer, 'event':'chat', 'chat':text]
        self.update_transcript('you', text)
        self.mesh.send(self.server, msgtext)
    end

    self.ui = sys.ui(self,
                    ['horizontal',

                        ['table', 'name':'roster', 'list':self.available_contacts(), 'logic':self.select, 'hfill':true, 'width':0.25],
                        ['vertical',
                            ['input', 'name':'transcript', 'multiline':true, 'readonly':true, 'hfill':true],
                            ['input', 'name':'sezme'],
                            ['button', 'text':'send', 'logic':send],
                        ]
                    ])
    self.peer = peer

end

client.update_transcript = function(self, from, text)
    if self.transcript.length then
        self.transcript = self.transcript + '\n'
    end
    self.transcript = self.transcript + from +':'+ text
    sys.ui_set(self.ui.transcript, self.transcript)
end

client.handle_chat = function(self, chat, from)

    if from == self.peer then
        self.update_transcript(from, chat)
    else
        self.unread[from] = self.unread + [chat]
        roster = [r+ '(' + self.unread[r].length + ')' for r in self.contacts where r.online]
        sys.ui_set(self.ui.roster, roster)
    end

end

client.send = function(self, other, text)

    text = text or sys.form_get(self.ui).sezme
    msgtext = ['event':'text', 'text':text]
    other = other or peer
    self.mesh.send_to(other, msgtext)

end

client.showContacts = function(self)

    self.ui = sys.ui(self, ['vertical',
                        ['table', 'name':'contacts', 'list':self.contacts.keys, 'logic':self.selectContact],
                        ['button', 'text':'back to settings', 'logic':self.settings],
                        self.w, self.h
                    ])
end

client.selectContact = function(self)

    row = sys.args()[1]
    self.peer = self.contacts.keys[row]

    sys.print('sp='+self.peer)

    self.ui = sys.ui(self, ['vertical',
                        ['label', 'text':self.peer],
                        ['form', 'name'],
                        ['button', 'text':'delete', 'logic':self.deleteContact],
                        self.w, self.h
                    ])

    sys.form_set(['name':self.peer])

end

client.deleteContact = function(self)

    self.contacts = self.contacts - self.peer
    mc4 = ['event' : 'contacts', 'contacts' : self.contacts]
    self.mesh.send_to('server', mc4)
    self.settings()

end

client.settings = function(client)

    client.ui = sys.ui(client, ['vertical',

                        ['form', 'server', 'display name', 'id', 'password'],

                        ['button', 'text':'contacts', 'logic':client.showContacts],

                        ['horizontal',
                            ['button', 'text':'save',   'logic':sys.save(sys.form_get(client.ui), 'settings')],
                            ['button', 'text':'cancel', 'logic':client.main],
                            ['button', 'text':'logout', 'logic':client.main],
                        ],

                        client.w, client.h
                    ])

    f = sys.load('settings')
    sys.form_set(f)
end

client.main = function(self)

    self.ui = sys.ui(self, ['vertical',

                                ['horizontal',
                                    ['button', 'text':'add',      'logic':self.add],
                                    ['button', 'text':'settings', 'logic':self.settings],
                                ],

                                ['table', 'name':'roster', 'list':self.available_contacts(), 'logic':self.select],

                                self.w, self.h
                            ])

end

client.add = function(self)

    self.ui = sys.ui(self,

                    ['vertical',

                        ['form', 'id'],

                        ['horizontal',
                            ['button', 'text':'add',       'logic':self.added],
                            ['button', 'text':'nevermind', 'logic':self.main],
                        ],

                        self.w, self.h
                    ])
end


client.added = function(self)
    friend = sys.form_get(self.ui).id
    self.add_contact(friend)
    self.main()
end

client.add_contact = function(self, friend)
    self.contacts = self.contacts + [friend:[]]
    sys.print('fz ' + friend + ' -- ' + self.contacts)
    mc4 = ['event' : 'contacts', 'contacts' : self.contacts]
    self.mesh.send_to('server', mc4)
end

client.signin = function(self, id, pw, entrance)
    sys.print('signin ' + self.creds)
    self.creds = self.creds or sys.form_get(self.ui) or ['id':id, 'password':pw]
    self.entrance = entrance or 'signin'
    self.mesh = self.mesh.init(self.creds.id, self.port, [self])
    self.mesh.connect()
end

client.signup = function(self, id, pw)
    self.signin(id, pw, 'signup')
end

client.ui_login = function(self)
    self.ui = sys.ui(self, ['vertical',
                                 ['form', 'server', 'id', 'password'],
                                 ['horizontal',
                                     ['button', 'text':'signin', 'logic':self.signin],
                                     ['button', 'text':'signup', 'logic':self.signup],
                                 ],
                                 self.w, self.h
                            ])
end

client.login = function(self)

    # todo -- make autologin work
    #if self.creds = sys.load('creds') then
    #    self.signin()
    #else
        self.ui_login()
        sys.loop()
    #end
end

client.login()

sys.loop()
